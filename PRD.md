# Product Requirements Document: privy-agent0-provider

> **Version:** 0.1.0 · **License:** MIT · **Status:** Initial release

---

## 1. Overview

**privy-agent0-provider** is a TypeScript library that bridges [Privy's agentic wallets](https://docs.privy.io/recipes/agent-integrations/agentic-wallets) with the [Agent0 ERC-8004 SDK](https://sdk.ag0.xyz/docs) via the standard [EIP-1193](https://eips.ethereum.org/EIPS/eip-1193) provider interface.

### Problem

The Agent0 SDK requires an EIP-1193 provider (`{ request }`) to sign transactions and messages for on-chain agent registration. Privy's agentic wallets keep the Ethereum private key locked inside a secure enclave — there is no raw key to hand to a standard provider. Developers need a thin adapter that speaks EIP-1193 on one side and Privy's authorization-key protocol on the other.

### Who it's for

- **Backend developers** building AI agent systems that register on-chain identities via the ERC-8004 standard.
- **Teams using Privy** for managed wallet custody who want to integrate with the Agent0 ecosystem without exposing raw private keys.

### What it does

1. Creates an EIP-1193-compatible `request()` function that routes signing operations through Privy's enclave.
2. Manages the full wallet lifecycle: create, persist to disk, load, and reuse.
3. Optionally exposes a raw viem `WalletClient` for use outside the Agent0 SDK.

> **SDK compatibility:** Agent0 SDK v1.5.3 supports both `privateKey` (raw hex string) and `walletProvider` (EIP-1193 `Eip1193Provider`) in its `SDKConfig`. This library implements the `walletProvider` path so that no raw private key is ever exposed to user code.

---

## 2. Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  Your Server                                                    │
│                                                                 │
│  ┌──────────────┐    ┌───────────────────┐    ┌──────────────┐ │
│  │  Agent0 SDK  │───▶│ createPrivyProvider│───▶│ viem         │ │
│  │  (ERC-8004)  │    │ (EIP-1193 adapter) │    │ WalletClient │ │
│  └──────────────┘    └───────────────────┘    └──────┬───────┘ │
│                                                       │         │
│  P-256 authorization key (proves identity) ───────────┤         │
│                                                       ▼         │
├───────────────────────────────────────────────────────┤─────────┤
│  Privy Enclave                                        │         │
│                                                       │         │
│  • Verifies P-256 authorization signature             │         │
│  • Holds secp256k1 Ethereum private key               │         │
│  • Applies wallet policies                            │         │
│  • Signs transaction / message ───────────────────────┘         │
│                                                       │         │
├───────────────────────────────────────────────────────┤─────────┤
│  Ethereum Network                                     │         │
│                                                       ▼         │
│  • Receives signed transaction                                  │
│  • ERC-8004 Registry contract                                   │
└─────────────────────────────────────────────────────────────────┘
```

**Three-party relationship:**

| Party | Role |
|---|---|
| **Your Server** | Holds the P-256 authorization key. Initiates signing requests through the EIP-1193 provider. |
| **Privy Enclave** | Custodies the secp256k1 Ethereum private key. Verifies the P-256 authorization signature before signing. Enforces policies. |
| **Ethereum Network** | Receives the fully-signed transaction. The ERC-8004 Registry contract processes agent registrations. |

---

## 3. Core Paradigms & Patterns

### 3.1 EIP-1193 Provider Pattern

The library's primary export, `createPrivyProvider()`, returns an object with a single `request()` method:

```ts
{ request(args: { method: string; params?: unknown[] | Record<string, unknown> }): Promise<unknown> }
```

This satisfies the `EIP1193Provider` type expected by `agent0-sdk`'s `walletProvider` config option. Signing methods are handled locally via a viem `WalletClient`; all other JSON-RPC methods are proxied to the configured RPC URL.

### 3.2 Two-Key Security Model

| Key | Curve | Purpose | Location |
|---|---|---|---|
| **Authorization key** | P-256 (NIST) | Proves the caller is allowed to request signatures | Your server (base64 PKCS8) |
| **Signing key** | secp256k1 | Signs Ethereum transactions and messages | Privy's secure enclave (never exported) |

The authorization key is generated by `generateP256KeyPair()` from `@privy-io/node`. It is **not** an Ethereum key — it is a NIST P-256 keypair used to authenticate requests to Privy's API.

### 3.3 Wallet Lifecycle

```
create ──▶ save ──▶ load ──▶ use
              ▲         │
              └─────────┘  (subsequent runs)
```

| Stage | Function | Description |
|---|---|---|
| **Create** | `createWallet()` | Generates a P-256 keypair, calls Privy API to create an Ethereum wallet owned by that keypair. |
| **Save** | `saveWallet()` | Writes wallet details to `.privy-wallet.json` (or custom path). |
| **Load** | `loadWallet()` | Reads the persisted JSON file, returns `null` if absent. |
| **Use** | `createPrivyProvider()` / `createPrivyWalletClient()` | Constructs a provider or viem client from the wallet credentials. |
| **Convenience** | `getOrCreateWallet()` | Combines load + create + save into a single call. |

### 3.4 Peer Dependency Design

The library declares three peer dependencies to avoid bundling large packages and to let consumers control versions:

| Package | Version Constraint | Role |
|---|---|---|
| `@privy-io/node` | `>=0.9.0` | Privy server SDK — wallet creation, `createViemAccount` |
| `viem` | `>=2.0.0` | Ethereum interaction — `WalletClient`, chain definitions, types |
| `agent0-sdk` | `>=1.5.0` | Agent0 ERC-8004 SDK — consumes the EIP-1193 provider (requires v1.5.0+ for `walletProvider` support) |

> **Note:** The Agent0 SDK is alpha-quality software under rapid iteration. Pin exact versions in your lock file and test upgrades before deploying.

---

## 4. Module Reference

### `src/types.ts` — Type Definitions

| Export | Kind | Description |
|---|---|---|
| `PrivyProviderConfig` | `interface` | Full configuration for `createPrivyProvider()` and `createPrivyWalletClient()`. Fields: `privyAppId`, `privyAppSecret`, `walletId`, `walletAddress` (Hex), `authorizationPrivateKey`, `rpcUrl`, `chainId`. |
| `CreateWalletOptions` | `interface` | Credentials for wallet creation. Fields: `privyAppId`, `privyAppSecret`. |
| `PersistedWallet` | `interface` | Shape of `.privy-wallet.json`. Fields: `walletId`, `address`, `authPrivateKey`, `authPublicKey`, `createdAt`. |

### `src/provider.ts` — EIP-1193 Provider

| Export | Signature | Description |
|---|---|---|
| `createPrivyProvider` | `(config: PrivyProviderConfig) => { request(...): Promise<unknown> }` | Creates an EIP-1193 provider. Signing operations are routed through a viem `WalletClient` backed by Privy's `createViemAccount`. All other RPC calls are proxied to `config.rpcUrl`. |

### `src/wallet-client.ts` — viem WalletClient

| Export | Signature | Description |
|---|---|---|
| `createPrivyWalletClient` | `(config: PrivyProviderConfig) => WalletClient` | Creates a viem `WalletClient` backed by a Privy wallet. Useful for direct viem usage outside of the Agent0 SDK. |

### `src/wallet.ts` — Wallet Lifecycle

| Export | Signature | Description |
|---|---|---|
| `createWallet` | `(opts: CreateWalletOptions) => Promise<PersistedWallet>` | Generates a P-256 keypair and creates a new Ethereum wallet via Privy. |
| `loadWallet` | `(filePath?: string) => PersistedWallet \| null` | Reads a persisted wallet from disk. Returns `null` if the file doesn't exist. |
| `saveWallet` | `(wallet: PersistedWallet, filePath?: string) => void` | Writes a wallet to a JSON file. |
| `getOrCreateWallet` | `(opts: CreateWalletOptions, filePath?: string) => Promise<PersistedWallet>` | Loads from disk if available, otherwise creates and saves a new wallet. |

### `src/chains.ts` — Chain Resolution

| Export | Signature | Description |
|---|---|---|
| `CHAIN_MAP` | `Record<number, Chain>` | Maps chain IDs to viem `Chain` objects. |
| `resolveChain` | `(chainId: number) => Chain` | Looks up a chain by ID. Throws if unsupported. |

### `src/index.ts` — Barrel Export

Re-exports all public functions and types from the modules above.

---

## 5. EIP-1193 Method Handling

The provider returned by `createPrivyProvider()` handles specific methods locally and proxies everything else to the JSON-RPC endpoint.

| Method | Handling | Description |
|---|---|---|
| `eth_accounts` | **Local** | Returns `[walletAddress]` |
| `eth_requestAccounts` | **Local** | Returns `[walletAddress]` |
| `eth_chainId` | **Local** | Returns `0x`-prefixed hex chain ID |
| `eth_sendTransaction` | **Signing (Privy)** | Extracts `to`, `data`, `value`, `gas`, `nonce` from params and delegates to `walletClient.sendTransaction()` |
| `personal_sign` | **Signing (Privy)** | Passes the raw hex message to `walletClient.signMessage()` |
| `eth_signTypedData_v4` | **Signing (Privy)** | Parses EIP-712 typed data (handles both string and object input), strips `EIP712Domain` from types, delegates to `walletClient.signTypedData()` |
| All other methods | **Proxied to RPC** | Forwarded via `fetch()` POST to `config.rpcUrl` |

---

## 6. Supported Chains

| Chain | Chain ID | viem Import |
|---|---|---|
| Ethereum Mainnet | `1` | `mainnet` |
| Sepolia (testnet) | `11155111` | `sepolia` |
| Base | `8453` | `base` |
| Polygon Mainnet | `137` | `polygon` |
| Base Sepolia (testnet) | `84532` | `baseSepolia` |

These chains correspond to known ERC-8004 registry deployments and Agent0 SDK subgraph support.

**ERC-8004 Registry Addresses (reference):**

| Chain | ID | Identity Registry | Reputation Registry |
|---|---|---|---|
| Ethereum Mainnet | 1 | `0x8004A169...` | `0x8004BAa1...` |
| Base Mainnet | 8453 | (same) | (same) |
| Polygon Mainnet | 137 | (same) | (same) |
| Sepolia | 11155111 | `0x8004A818...` | `0x8004B663...` |
| Base Sepolia | 84532 | (same) | (same) |

Passing an unsupported chain ID to `resolveChain()` throws:

```
Unsupported chain ID: <id>. Supported: 1, 11155111, 8453, 137, 84532
```

---

## 7. Integration Guide: Using Privy with Agent0 SDK

### Prerequisites

1. **Privy Dashboard** — Create an app at [dashboard.privy.io](https://dashboard.privy.io). Copy the **App ID** and **App Secret**.
2. **Pinata** — Get a JWT from [pinata.cloud](https://pinata.cloud) for IPFS uploads (required by Agent0 SDK for metadata storage).
3. **RPC URL** — Optional. Defaults to `https://ethereum-sepolia-rpc.publicnode.com` in the examples.
4. **Install dependencies:**

```bash
yarn add privy-agent0-provider @privy-io/node viem agent0-sdk
```

5. **Environment setup** — Copy `.env.example` to `.env` and fill in credentials.

---

### Path A: Auto-Create Wallet Flow

Use `getOrCreateWallet()` for the simplest setup. On first run it creates a wallet and persists it to `.privy-wallet.json`. Subsequent runs reuse that wallet.

```ts
import 'dotenv/config';
import { SDK } from 'agent0-sdk';
import { getOrCreateWallet, createPrivyProvider } from 'privy-agent0-provider';
import type { Hex } from 'viem';

// 1. Get or create a Privy wallet
const wallet = await getOrCreateWallet({
  privyAppId: process.env.PRIVY_APP_ID!,
  privyAppSecret: process.env.PRIVY_APP_SECRET!,
});

// 2. Create EIP-1193 provider
const provider = createPrivyProvider({
  privyAppId: process.env.PRIVY_APP_ID!,
  privyAppSecret: process.env.PRIVY_APP_SECRET!,
  walletId: wallet.walletId,
  walletAddress: wallet.address as Hex,
  authorizationPrivateKey: wallet.authPrivateKey,
  rpcUrl: process.env.RPC_URL || 'https://ethereum-sepolia-rpc.publicnode.com',
  chainId: 11155111,
});

// 3. Initialize Agent0 SDK with the provider
const sdk = new SDK({
  chainId: 11155111,
  rpcUrl: process.env.RPC_URL || 'https://ethereum-sepolia-rpc.publicnode.com',
  walletProvider: provider,
  ipfs: 'pinata',
  pinataJwt: process.env.PINATA_JWT!,
});

// 4. Register an agent
const agent = sdk.createAgent(
  'My Agent',
  'An agent registered with a Privy agentic wallet',
);
await agent.setA2A('https://my-agent.example.com/.well-known/agent-card.json');
agent.setTrust(true, true, true);
agent.setActive(false);

const txHandle = await agent.registerIPFS();
const { result } = await txHandle.waitMined();
console.log('Agent ID:', result.agentId);
```

**Required env vars:** `PRIVY_APP_ID`, `PRIVY_APP_SECRET`, `PINATA_JWT`

Run: `yarn example:auto`

---

### Path B: Existing Wallet Flow

Use `createPrivyProvider()` directly when you already have a wallet created through the Privy Dashboard. All configuration comes from environment variables.

```ts
import 'dotenv/config';
import { SDK } from 'agent0-sdk';
import { createPrivyProvider } from 'privy-agent0-provider';
import type { Hex } from 'viem';

// 1. Create EIP-1193 provider from env vars
const provider = createPrivyProvider({
  privyAppId: process.env.PRIVY_APP_ID!,
  privyAppSecret: process.env.PRIVY_APP_SECRET!,
  walletId: process.env.PRIVY_WALLET_ID!,
  walletAddress: process.env.PRIVY_WALLET_ADDRESS! as Hex,
  authorizationPrivateKey: process.env.PRIVY_AUTH_PRIVATE_KEY!,
  rpcUrl: process.env.RPC_URL || 'https://ethereum-sepolia-rpc.publicnode.com',
  chainId: 11155111,
});

// 2. Initialize Agent0 SDK
const sdk = new SDK({
  chainId: 11155111,
  rpcUrl: process.env.RPC_URL || 'https://ethereum-sepolia-rpc.publicnode.com',
  walletProvider: provider,
  ipfs: 'pinata',
  pinataJwt: process.env.PINATA_JWT!,
});

// 3. Register an agent
const agent = sdk.createAgent(
  'My Agent',
  'An agent registered with an existing Privy wallet',
);
await agent.setA2A('https://my-agent.example.com/.well-known/agent-card.json');
agent.setTrust(true, true, true);
agent.setActive(false);

const txHandle = await agent.registerIPFS();
const { result } = await txHandle.waitMined();
console.log('Agent ID:', result.agentId);
```

**Required env vars:** `PRIVY_APP_ID`, `PRIVY_APP_SECRET`, `PRIVY_WALLET_ID`, `PRIVY_WALLET_ADDRESS`, `PRIVY_AUTH_PRIVATE_KEY`, `PINATA_JWT`

Run: `yarn example:existing`

---

## 8. Environment Variables

| Variable | Required | Used By | Description |
|---|---|---|---|
| `PRIVY_APP_ID` | **Yes** | All flows | Privy App ID from the Dashboard |
| `PRIVY_APP_SECRET` | **Yes** | All flows | Privy App Secret from the Dashboard |
| `PRIVY_WALLET_ID` | Path B only | `createPrivyProvider()` | Wallet ID of an existing Privy wallet |
| `PRIVY_WALLET_ADDRESS` | Path B only | `createPrivyProvider()` | Ethereum address of the existing wallet |
| `PRIVY_AUTH_PRIVATE_KEY` | Path B only | `createPrivyProvider()` | Base64-encoded PKCS8 P-256 authorization private key |
| `PINATA_JWT` | For examples | Agent0 SDK | Pinata JWT for IPFS metadata uploads |
| `RPC_URL` | No | All flows | JSON-RPC endpoint. Defaults to `https://ethereum-sepolia-rpc.publicnode.com` |

---

## 9. Security Model

### Key Custody

| Secret | Storage | Exposure |
|---|---|---|
| **Ethereum private key** (secp256k1) | Privy's secure enclave | **Never exported.** Not accessible to the library or your server. |
| **Authorization private key** (P-256) | Your server — in `.privy-wallet.json` or env vars | Used to authenticate signing requests. Must be protected like any server secret. |
| **Privy App Secret** | Your server — env vars | Authenticates your app with the Privy API. |

### Authorization Flow

1. Your server calls `walletClient.sendTransaction()` (or `signMessage`, etc.).
2. The viem account created by `createViemAccount()` signs the request payload with the P-256 authorization private key.
3. Privy's API verifies the P-256 signature against the public key registered as the wallet's owner.
4. If valid (and if policies permit), the enclave signs the Ethereum transaction with the secp256k1 key.
5. The signed transaction is returned to the caller and broadcast to the network.

### Enclave Guarantees

- The Ethereum private key is generated and stored within Privy's enclave infrastructure.
- Key material is never transmitted outside the enclave boundary.
- All signing operations execute within the enclave.

### Privy Policies

Policies can be configured in the Privy Dashboard to restrict wallet operations — for example, limiting which contracts the wallet can interact with, capping transaction values, or requiring additional approvals. These policies are enforced at the enclave level before signing.

### File Security

The `.privy-wallet.json` file contains the authorization private key. It is:
- Listed in `.gitignore` to prevent accidental commits.
- Should be treated as a secret with appropriate file permissions.
- Can be replaced by environment variables in production (Path B).

### Authorization Key Storage Recommendations

| Environment | Recommended Backend | Notes |
|---|---|---|
| **Development** | Environment variables or flat file (`.privy-wallet.json`) | Current default. Acceptable for local dev only. |
| **Production** | AWS KMS (`ECC_NIST_P256`), GCP Cloud KMS (`EC_SIGN_P256_SHA256`), or a secrets manager | Keys never leave the HSM. FIPS 140-2 Level 3. |

**Key rotation:** Privy recommends rotating authorization keys every 90–180 days. Plan rotation procedures before going to production.

**Key separation:** Use distinct authorization keys for transaction signing versus policy management. Even if transaction signing keys are compromised, an attacker cannot modify the policies that constrain wallet behavior.

### Operational Security

- **Idempotency keys:** Use idempotency keys on signing requests to prevent duplicate transaction submission during retries.
- **Rate limiting:** Be aware of Privy API rate limits, especially in multi-agent deployments where many wallets may issue concurrent signing requests.
- **Version pinning:** The Agent0 SDK is alpha software. Pin exact versions in lock files and validate upgrades in staging before production deployment.

---

## 10. Build & Development

### Scripts

| Script | Command | Description |
|---|---|---|
| `build` | `tsc` | Compiles TypeScript to JavaScript in `dist/` |
| `clean` | `rm -rf dist` | Removes build artifacts |
| `prepublishOnly` | `yarn build` | Ensures a fresh build before `npm publish` |
| `example:auto` | `tsx examples/register-auto.ts` | Runs the auto-create wallet example |
| `example:existing` | `tsx examples/register-existing.ts` | Runs the existing wallet example |

### TypeScript Configuration

| Setting | Value | Notes |
|---|---|---|
| `target` | `ES2022` | Modern JS — top-level await, private fields |
| `module` | `NodeNext` | ESM with `.js` extensions in imports |
| `moduleResolution` | `NodeNext` | Matches the module setting |
| `strict` | `true` | Full type checking |
| `declaration` | `true` | Generates `.d.ts` files |
| `declarationMap` | `true` | Enables go-to-definition in consumers |
| `sourceMap` | `true` | Debugging support |
| `esModuleInterop` | `true` | CommonJS interop |
| `skipLibCheck` | `true` | Faster builds |

**ESM-only:** The package sets `"type": "module"` in `package.json`. All source imports use `.js` extensions (required by NodeNext resolution). There is no CommonJS build.

---

## 11. Package Distribution

### Exports Map

```json
{
  ".": {
    "import": "./dist/index.js",
    "types": "./dist/index.d.ts"
  }
}
```

Only the ESM entry point is exposed. The `"files"` field limits the published package to the `dist/` directory.

### Peer Dependencies

| Package | Version | Why Peer |
|---|---|---|
| `@privy-io/node` | `>=0.9.0` | Avoids duplicate Privy client instances; consumers control the version |
| `viem` | `>=2.0.0` | Large dependency — consumers likely already have it |
| `agent0-sdk` | `>=1.5.0` | Requires v1.5.0+ for `walletProvider` support in `SDKConfig` |

### Dev Dependencies

| Package | Version | Purpose |
|---|---|---|
| `@privy-io/node` | `^0.9.0` | Local development and examples |
| `@types/node` | `^20.10.0` | Node.js type definitions |
| `agent0-sdk` | `latest` | Local development and examples |
| `dotenv` | `^16.3.1` | `.env` file loading in examples |
| `graphql` | `^16.12.0` | Transitive dependency required by agent0-sdk |
| `tsx` | `^4.7.0` | TypeScript execution for examples |
| `typescript` | `^5.3.0` | Compiler |
| `viem` | `^2.0.0` | Local development and examples |

### Versioning

The package follows semantic versioning. Current version: **0.1.0** (pre-1.0, API may change between minor versions).

### Repository

```
https://github.com/agent0-xyz/privy-agent0-provider
```

### Keywords

`privy`, `agent0`, `erc-8004`, `eip-1193`, `viem`, `wallet`, `agentic`, `ethereum`

---

## 12. Roadmap

Future features planned beyond v0.1.0, collected here for visibility:

1. **KeyProvider abstraction** — Pluggable P-256 key backends (AWS KMS `ECC_NIST_P256`, GCP Cloud KMS, HashiCorp Vault, environment variable). A `KeyProvider` interface (`{ sign(payload: Buffer): Promise<Buffer>; getPublicKey(): string }`) would let operators choose their backend without code changes.

2. **Reputation & Validation Registry helpers** — Expose helpers for submitting feedback (scored 0–100 with tags), generating and verifying `feedbackAuth` signatures (EIP-191/ERC-1271) using Privy wallets, and bridging Privy's TEE attestation to the ERC-8004 Validation Registry.

3. **Smart wallet paths** — ERC-4337 smart wallet support via Privy's native integrations (Kernel/ZeroDev, Safe, LightAccount, etc.) for transaction batching and gas sponsorship. ERC-6551 token-bound accounts for agent identities — since ERC-8004 agent identities are ERC-721 tokens, they can inherently own assets via token-bound accounts.

4. **x402 protocol support** — Setting `x402Support: true` in agent registration metadata, linking x402 payment proofs to reputation feedback, and configuring Privy wallets for HTTP 402 payment flows.

5. **Dynamic chain registry** — Runtime chain resolution from an on-chain or off-chain registry instead of the static `CHAIN_MAP`, enabling automatic support for new ERC-8004 deployments without library updates.
